"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createSessionHandler = createSessionHandler;
exports.scheduleSessionHandler = scheduleSessionHandler;
exports.createMessageHandler = createMessageHandler;
exports.getSessionTranscriptHandler = getSessionTranscriptHandler;
exports.getSessionsHandler = getSessionsHandler;
exports.getUserSessionsHandler = getUserSessionsHandler;
exports.getSessionHandler = getSessionHandler;
exports.endSessionHandler = endSessionHandler;
const sessions_service_1 = require("./sessions.service");
async function createSessionHandler(request, reply) {
    try {
        const user = request.user;
        const session = await (0, sessions_service_1.createSession)(user.sub, request.body);
        return reply.code(201).send(session);
    }
    catch (error) {
        console.error('Error in createSessionHandler:', error);
        if (error.message.includes('User profile not found')) {
            return reply.code(400).send({ message: error.message });
        }
        throw error;
    }
}
async function scheduleSessionHandler(request, reply) {
    try {
        const user = request.user;
        // Force type to be scheduled
        const input = { ...request.body, type: 'scheduled' };
        const session = await (0, sessions_service_1.createSession)(user.sub, input);
        return reply.code(201).send(session);
    }
    catch (error) {
        console.error('Error in scheduleSessionHandler:', error);
        if (error.message.includes('User profile not found')) {
            return reply.code(400).send({ message: error.message });
        }
        throw error;
    }
}
async function createMessageHandler(request, reply) {
    try {
        const user = request.user;
        const message = await (0, sessions_service_1.createMessage)(user.sub, request.params.id, request.body);
        return reply.code(201).send(message);
    }
    catch (error) {
        if (error.message === 'Session not found') {
            return reply.code(404).send({ message: 'Session not found' });
        }
        throw error;
    }
}
async function getSessionTranscriptHandler(request, reply) {
    try {
        const user = request.user;
        const messages = await (0, sessions_service_1.getSessionTranscript)(user.sub, request.params.id);
        return reply.send(messages);
    }
    catch (error) {
        if (error.message === 'Session not found') {
            return reply.code(404).send({ message: 'Session not found' });
        }
        throw error;
    }
}
async function getSessionsHandler(request, reply) {
    const user = request.user;
    const sessions = await (0, sessions_service_1.getSessions)(user.sub, request.query.status);
    return reply.send(sessions);
}
async function getUserSessionsHandler(request, reply) {
    const sessions = await (0, sessions_service_1.getSessions)(request.params.userId);
    return reply.send(sessions);
}
async function getSessionHandler(request, reply) {
    const user = request.user;
    const session = await (0, sessions_service_1.getSessionById)(user.sub, request.params.id);
    if (!session) {
        return reply.code(404).send({ message: 'Session not found' });
    }
    return reply.send(session);
}
async function endSessionHandler(request, reply) {
    try {
        const user = request.user;
        const session = await (0, sessions_service_1.endSession)(user.sub, request.params.id, request.body.duration_seconds);
        return reply.send(session);
    }
    catch (error) {
        if (error.message === 'Session not found') {
            return reply.code(404).send({ message: 'Session not found' });
        }
        throw error;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzovVXNlcnMvU2FpZiBBbGkvRG9jdW1lbnRzL0dpdEh1Yi9NZWV0RXpyaS9hcHBzL2FwaS9zcmMvbW9kdWxlcy9zZXNzaW9ucy9zZXNzaW9ucy5jb250cm9sbGVyLnRzIiwic291cmNlcyI6WyJDOi9Vc2Vycy9TYWlmIEFsaS9Eb2N1bWVudHMvR2l0SHViL01lZXRFenJpL2FwcHMvYXBpL3NyYy9tb2R1bGVzL3Nlc3Npb25zL3Nlc3Npb25zLmNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFVQSxvREFlQztBQUVELHdEQWlCQztBQUVELG9EQWNDO0FBRUQsa0VBY0M7QUFFRCxnREFPQztBQUVELHdEQU1DO0FBRUQsOENBVUM7QUFFRCw4Q0FjQztBQXhIRCx5REFBaUk7QUFTMUgsS0FBSyxVQUFVLG9CQUFvQixDQUN4QyxPQUFxRCxFQUNyRCxLQUFtQjtJQUVuQixJQUFJLENBQUM7UUFDSCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBbUIsQ0FBQztRQUN6QyxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUEsZ0NBQWEsRUFBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1RCxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyx3QkFBd0IsQ0FBQyxFQUFFLENBQUM7WUFDckQsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBQ0QsTUFBTSxLQUFLLENB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TyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxtQkFBbUIsRUFBRSxDQUFDO1lBQzFDLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7UUFDRCxNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmFzdGlmeVJlcGx5LCBGYXN0aWZ5UmVxdWVzdCB9IGZyb20gJ2Zhc3RpZnknO1xyXG5pbXBvcnQgeyBjcmVhdGVTZXNzaW9uLCBnZXRTZXNzaW9ucywgZ2V0U2Vzc2lvbkJ5SWQsIGVuZFNlc3Npb24sIGNyZWF0ZU1lc3NhZ2UsIGdldFNlc3Npb25UcmFuc2NyaXB0IH0gZnJvbSAnLi9zZXNzaW9ucy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ3JlYXRlU2Vzc2lvbklucHV0LCBFbmRTZXNzaW9uSW5wdXQsIENyZWF0ZU1lc3NhZ2VJbnB1dCB9IGZyb20gJy4vc2Vzc2lvbnMuc2NoZW1hJztcclxuXHJcbmludGVyZmFjZSBVc2VyUGF5bG9hZCB7XHJcbiAgc3ViOiBzdHJpbmc7XHJcbiAgZW1haWw/OiBzdHJpbmc7XHJcbiAgcm9sZT86IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNlc3Npb25IYW5kbGVyKFxyXG4gIHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0PHsgQm9keTogQ3JlYXRlU2Vzc2lvbklucHV0IH0+LFxyXG4gIHJlcGx5OiBGYXN0aWZ5UmVwbHlcclxuKSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHVzZXIgPSByZXF1ZXN0LnVzZXIgYXMgVXNlclBheWxvYWQ7XHJcbiAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgY3JlYXRlU2Vzc2lvbih1c2VyLnN1YiwgcmVxdWVzdC5ib2R5KTtcclxuICAgIHJldHVybiByZXBseS5jb2RlKDIwMSkuc2VuZChzZXNzaW9uKTtcclxuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBjcmVhdGVTZXNzaW9uSGFuZGxlcjonLCBlcnJvcik7XHJcbiAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnVXNlciBwcm9maWxlIG5vdCBmb3VuZCcpKSB7XHJcbiAgICAgIHJldHVybiByZXBseS5jb2RlKDQwMCkuc2VuZCh7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSk7XHJcbiAgICB9XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzY2hlZHVsZVNlc3Npb25IYW5kbGVyKFxyXG4gIHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0PHsgQm9keTogQ3JlYXRlU2Vzc2lvbklucHV0IH0+LFxyXG4gIHJlcGx5OiBGYXN0aWZ5UmVwbHlcclxuKSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHVzZXIgPSByZXF1ZXN0LnVzZXIgYXMgVXNlclBheWxvYWQ7XHJcbiAgICAvLyBGb3JjZSB0eXBlIHRvIGJlIHNjaGVkdWxlZFxyXG4gICAgY29uc3QgaW5wdXQgPSB7IC4uLnJlcXVlc3QuYm9keSwgdHlwZTogJ3NjaGVkdWxlZCcgYXMgY29uc3QgfTtcclxuICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCBjcmVhdGVTZXNzaW9uKHVzZXIuc3ViLCBpbnB1dCk7XHJcbiAgICByZXR1cm4gcmVwbHkuY29kZSgyMDEpLnNlbmQoc2Vzc2lvbik7XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gc2NoZWR1bGVTZXNzaW9uSGFuZGxlcjonLCBlcnJvcik7XHJcbiAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnVXNlciBwcm9maWxlIG5vdCBmb3VuZCcpKSB7XHJcbiAgICAgIHJldHVybiByZXBseS5jb2RlKDQwMCkuc2VuZCh7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSk7XHJcbiAgICB9XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVNZXNzYWdlSGFuZGxlcihcclxuICByZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdDx7IFBhcmFtczogeyBpZDogc3RyaW5nIH07IEJvZHk6IENyZWF0ZU1lc3NhZ2VJbnB1dCB9PixcclxuICByZXBseTogRmFzdGlmeVJlcGx5XHJcbikge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB1c2VyID0gcmVxdWVzdC51c2VyIGFzIFVzZXJQYXlsb2FkO1xyXG4gICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IGNyZWF0ZU1lc3NhZ2UodXNlci5zdWIsIHJlcXVlc3QucGFyYW1zLmlkLCByZXF1ZXN0LmJvZHkpO1xyXG4gICAgcmV0dXJuIHJlcGx5LmNvZGUoMjAxKS5zZW5kKG1lc3NhZ2UpO1xyXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgIGlmIChlcnJvci5tZXNzYWdlID09PSAnU2Vzc2lvbiBub3QgZm91bmQnKSB7XHJcbiAgICAgIHJldHVybiByZXBseS5jb2RlKDQwNCkuc2VuZCh7IG1lc3NhZ2U6ICdTZXNzaW9uIG5vdCBmb3VuZCcgfSk7XHJcbiAgICB9XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTZXNzaW9uVHJhbnNjcmlwdEhhbmRsZXIoXHJcbiAgcmVxdWVzdDogRmFzdGlmeVJlcXVlc3Q8eyBQYXJhbXM6IHsgaWQ6IHN0cmluZyB9IH0+LFxyXG4gIHJlcGx5OiBGYXN0aWZ5UmVwbHlcclxuKSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHVzZXIgPSByZXF1ZXN0LnVzZXIgYXMgVXNlclBheWxvYWQ7XHJcbiAgICBjb25zdCBtZXNzYWdlcyA9IGF3YWl0IGdldFNlc3Npb25UcmFuc2NyaXB0KHVzZXIuc3ViLCByZXF1ZXN0LnBhcmFtcy5pZCk7XHJcbiAgICByZXR1cm4gcmVwbHkuc2VuZChtZXNzYWdlcyk7XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgaWYgKGVycm9yLm1lc3NhZ2UgPT09ICdTZXNzaW9uIG5vdCBmb3VuZCcpIHtcclxuICAgICAgcmV0dXJuIHJlcGx5LmNvZGUoNDA0KS5zZW5kKHsgbWVzc2FnZTogJ1Nlc3Npb24gbm90IGZvdW5kJyB9KTtcclxuICAgIH1cclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNlc3Npb25zSGFuZGxlcihcclxuICByZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdDx7IFF1ZXJ5c3RyaW5nOiB7IHN0YXR1cz86IHN0cmluZyB9IH0+LFxyXG4gIHJlcGx5OiBGYXN0aWZ5UmVwbHlcclxuKSB7XHJcbiAgY29uc3QgdXNlciA9IHJlcXVlc3QudXNlciBhcyBVc2VyUGF5bG9hZDtcclxuICBjb25zdCBzZXNzaW9ucyA9IGF3YWl0IGdldFNlc3Npb25zKHVzZXIuc3ViLCByZXF1ZXN0LnF1ZXJ5LnN0YXR1cyk7XHJcbiAgcmV0dXJuIHJlcGx5LnNlbmQoc2Vzc2lvbnMpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0VXNlclNlc3Npb25zSGFuZGxlcihcclxuICByZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdDx7IFBhcmFtczogeyB1c2VySWQ6IHN0cmluZyB9IH0+LFxyXG4gIHJlcGx5OiBGYXN0aWZ5UmVwbHlcclxuKSB7XHJcbiAgY29uc3Qgc2Vzc2lvbnMgPSBhd2FpdCBnZXRTZXNzaW9ucyhyZXF1ZXN0LnBhcmFtcy51c2VySWQpO1xyXG4gIHJldHVybiByZXBseS5zZW5kKHNlc3Npb25zKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNlc3Npb25IYW5kbGVyKFxyXG4gIHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0PHsgUGFyYW1zOiB7IGlkOiBzdHJpbmcgfSB9PixcclxuICByZXBseTogRmFzdGlmeVJlcGx5XHJcbikge1xyXG4gIGNvbnN0IHVzZXIgPSByZXF1ZXN0LnVzZXIgYXMgVXNlclBheWxvYWQ7XHJcbiAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IGdldFNlc3Npb25CeUlkKHVzZXIuc3ViLCByZXF1ZXN0LnBhcmFtcy5pZCk7XHJcbiAgaWYgKCFzZXNzaW9uKSB7XHJcbiAgICByZXR1cm4gcmVwbHkuY29kZSg0MDQpLnNlbmQoeyBtZXNzYWdlOiAnU2Vzc2lvbiBub3QgZm91bmQnIH0pO1xyXG4gIH1cclxuICByZXR1cm4gcmVwbHkuc2VuZChzZXNzaW9uKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGVuZFNlc3Npb25IYW5kbGVyKFxyXG4gIHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0PHsgUGFyYW1zOiB7IGlkOiBzdHJpbmcgfTsgQm9keTogRW5kU2Vzc2lvbklucHV0IH0+LFxyXG4gIHJlcGx5OiBGYXN0aWZ5UmVwbHlcclxuKSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHVzZXIgPSByZXF1ZXN0LnVzZXIgYXMgVXNlclBheWxvYWQ7XHJcbiAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgZW5kU2Vzc2lvbih1c2VyLnN1YiwgcmVxdWVzdC5wYXJhbXMuaWQsIHJlcXVlc3QuYm9keS5kdXJhdGlvbl9zZWNvbmRzKTtcclxuICAgIHJldHVybiByZXBseS5zZW5kKHNlc3Npb24pO1xyXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgIGlmIChlcnJvci5tZXNzYWdlID09PSAnU2Vzc2lvbiBub3QgZm91bmQnKSB7XHJcbiAgICAgIHJldHVybiByZXBseS5jb2RlKDQwNCkuc2VuZCh7IG1lc3NhZ2U6ICdTZXNzaW9uIG5vdCBmb3VuZCcgfSk7XHJcbiAgICB9XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn1cclxuIl19